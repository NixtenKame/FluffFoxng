x-environment: &common-env
  DANBOORU_HOSTNAME: ${DANBOORU_HOSTNAME:-${SERVER_PROTOCOL:-http}://localhost:${EXPOSED_SERVER_PORT:-3000}}
  DANBOORU_DOMAIN: ${DANBOORU_DOMAIN:-localhost}
  DANBOORU_BUNKERWEB_ENABLED: ${DANBOORU_BUNKERWEB_ENABLED:-true}
  DANBOORU_BUNKERWEB_URL: ${DANBOORU_BUNKERWEB_URL:-https://localhost:${EXPOSED_BUNKERWEB_PORT:-8443}}
  DANBOORU_REDIS_URL: redis://redis
  DANBOORU_OPENSEARCH_HOST: opensearch
  DANBOORU_MEMCACHED_SERVERS: memcached
  DANBOORU_IQDB_SERVER: http://iqdb:5588
  DANBOORU_DISCORD_SECRET: super_secret_for_url_discord
  # These are just development secrets, do not use them in production
  DANBOORU_PROTECTED_FILE_SECRET: 6686a6413d90c43d5e82403ef271ec25d13cc24e3bfcdd094e73d1eff22a3567
  DANBOORU_REPLACEMENT_FILE_SECRET: b35bc54cdc0d0436fc5867c7ef88f9b10a37ae20a06b37e67614fe60019d7bb1
  SECRET_TOKEN: 1c58518a891eff4520cadc59afa9e378a9325f1247544ff258096e497f095f45
  SESSION_SECRET_KEY: 44b4f44e9f253c406cbe727d403d500c1cecff943e4d2aea8f5447f28846fffe
  # Hide annoying output from libvips on corrupt files
  VIPS_WARNING: "0"

x-depends-on: &common-depends-on
  opensearch:
    condition: service_healthy
  memcached:
    condition: service_started
  postgres:
    condition: service_started
  redis:
    condition: service_started

services:
  FluffFox:
    build:
      context: ./
      args:
        HOST_UID: ${HOST_UID:-1000}
        HOST_GID: ${HOST_GID:-1000}
    user: ${DOCKER_USER:-flufffoxng}
    image: flufffox
    volumes:
      - .:/app
      - node_modules:/app/node_modules
      - ./uploads:/app/public/data
      - ./docker/cron_tasks/daily:/etc/periodic/daily
    environment:
      <<: *common-env
      RAILS_ENV: development
      LOCAL_DTEXT: ${LOCAL_DTEXT:-}
      DANBOORU_DATA_BASE_URL: ${DANBOORU_DATA_BASE_URL:-http://localhost:9001}
    depends_on:
      <<: *common-depends-on
      autocompleted:
        condition: service_started
      iqdb:
        condition: service_started

  autocompleted:
    image: ghcr.io/e621ng/autocompleted:8807bc8658f594cd0de04de1c272c3a2f917fc48
    command: /app/autocompleted
    environment:
      SERVER_ADDR: autocompleted:8118
      PG__USER: FluffFox
      PG__HOST: postgres
      PG__PORT: 5432
      PG__DBNAME: FluffFox_development
      PG__POOL__MAX_SIZE: 1

  nginx:
    image: nginx:stable-alpine
    volumes:
      - ./public:/app/public
      - ./uploads:/app/public/data
      - ./docker/default.conf.template:/etc/nginx/templates/default.conf.template
    environment:
      <<: *common-env
      NGINX_PORT: ${EXPOSED_SERVER_PORT:-3000}
    depends_on:
      - autocompleted
      - FluffFox
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.flufffox.entrypoints=web"
      - "traefik.http.routers.flufffox.rule=Host(`flufffox.aws.local`) || Host(`ec2-34-205-197-51.compute-1.amazonaws.com`) || Host(`nixten.ddns.net`)"
      - "traefik.http.middlewares.redirect-https.redirectscheme.scheme=https"
      - "traefik.http.middlewares.redirect-https.redirectscheme.permanent=true"
      - "traefik.http.routers.flufffox.middlewares=redirect-https"
      - "traefik.http.routers.flufffox-https-public.entrypoints=websecure"
      - "traefik.http.routers.flufffox-https-public.rule=Host(`nixten.ddns.net`)"
      - "traefik.http.routers.flufffox-https-public.tls=true"
      - "traefik.http.routers.flufffox-https-public.tls.certresolver=le"
      - "traefik.http.routers.flufffox-https-local.entrypoints=websecure"
      - "traefik.http.routers.flufffox-https-local.rule=Host(`flufffox.aws.local`) || Host(`ec2-34-205-197-51.compute-1.amazonaws.com`)"
      - "traefik.http.routers.flufffox-https-local.tls=true"
      - "traefik.http.services.flufffox.loadbalancer.server.port=80"
    # nginx listens on the internal network; Traefik will publish host ports 80/443
  file-server:
    image: nginx:stable-alpine
    volumes:
      - ./uploads:/usr/share/nginx/html:ro
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.flufffox-files.entrypoints=websecure9001"
      - "traefik.http.routers.flufffox-files.rule=(Host(`flufffox.aws.local`) || Host(`ec2-34-205-197-51.compute-1.amazonaws.com`) || Host(`nixten.ddns.net`)) && PathPrefix(`/data`)"
      - "traefik.http.routers.flufffox-files.tls=true"
      - "traefik.http.services.flufffox-files.loadbalancer.server.port=80"
    command: sh -c "chmod o+rx /usr /usr/share /usr/share/nginx && echo 'server { listen 80; root /usr/share/nginx/html; autoindex on; location /data/ { alias /usr/share/nginx/html/; autoindex on; } location ~ /\. { deny all; } }' > /etc/nginx/conf.d/default.conf && nginx -g \"daemon off;\""    

  bunkerweb:
    image: bunkerity/bunkerweb:latest
    user: "0:0"
    ports:
      - "${EXPOSED_BUNKERWEB_PORT:-8443}:443"
    volumes:
      - bunkerweb_data:/var/lib/bunkerweb
    depends_on:
      - nginx
      - bunkerweb-ui
      - bunkerweb-scheduler
    environment:
      AUTOCONF_MODE: "no"
      KEEP_CONFIG_ON_RESTART: "yes"
    entrypoint:
      - /bin/sh
      - -lc
      - |
        cat > /tmp/variables.env <<EOF
        IS_LOADING=no
        KEEP_CONFIG_ON_RESTART=yes
        MULTISITE=yes
        HTTP_PORT=80
        HTTPS_PORT=443
        SERVER_NAME=${BUNKERWEB_SERVER_NAME}
        API_WHITELIST_IP=127.0.0.0/8 172.16.0.0/12
        USE_REVERSE_PROXY=yes
        REVERSE_PROXY_HOST=http://nginx:80
        REVERSE_PROXY_URL=/
        USE_WHITELIST=no
        AUTO_LETS_ENCRYPT=no
        USE_UI=yes
        UI_HOST=http://bunkerweb-ui:7000
        BUNKERWEB_INSTANCES=http://bunkerweb:5000
        DATABASE_URI=sqlite:////var/lib/bunkerweb/db.sqlite3
        EOF
        mkdir -p /var/cache/bunkerweb/misc
        if [ ! -f /var/cache/bunkerweb/misc/default-server-cert.pem ] || [ ! -f /var/cache/bunkerweb/misc/default-server-cert.key ]; then
          openssl req -x509 -nodes -newkey rsa:2048 \
            -keyout /var/cache/bunkerweb/misc/default-server-cert.key \
            -out /var/cache/bunkerweb/misc/default-server-cert.pem \
            -days 3650 -subj "/CN=${DANBOORU_DOMAIN:-localhost}"
        fi
        python3 /usr/share/bunkerweb/gen/main.py --variables /tmp/variables.env
        exec /usr/share/bunkerweb/entrypoint.sh

  bunkerweb-ui:
    image: bunkerity/bunkerweb-ui:latest
    user: "0:0"
    ports:
      - "${EXPOSED_BUNKERWEB_UI_PORT:-7000}:7000"
    environment:
      DATABASE_URI: sqlite:////var/lib/bunkerweb/db.sqlite3
      BUNKERWEB_INSTANCES: http://bunkerweb:5000
      UI_LISTEN_PORT: "7000"
      BUNKERWEB_SERVER_NAME: ${BUNKERWEB_SERVER_NAME:-localhost}
    volumes:
      - bunkerweb_data:/var/lib/bunkerweb
    entrypoint:
      - /bin/sh
      - -lc
      - |
        sed -i 's/!e.length||!e.val()||!e.get(0).checkValidity()/!e.length||!e.val()||!e.val().trim()/g' /usr/share/bunkerweb/ui/app/static/js/pages/setup.js
        sed -i 's/val(e.val())/val(e.val().trim())/g' /usr/share/bunkerweb/ui/app/static/js/pages/setup.js
        python3 - <<'PY'
        from pathlib import Path
        p = Path("/usr/share/bunkerweb/ui/app/static/js/pages/setup.js")
        s = p.read_text()
        dollar = chr(36)
        old = 'if(' + dollar + '("#setup-subscribe-newsletter").prop("checked")){'
        new = 'if(false&&' + dollar + '("#setup-subscribe-newsletter").prop("checked")){'
        if old in s:
          p.write_text(s.replace(old, new, 1))
        PY
        (
          DB="/var/lib/bunkerweb/db.sqlite3"
          DOMAIN="${BUNKERWEB_SERVER_NAME:-localhost}"
          for _ in $$(seq 1 90); do
            if [ -f "$$DB" ] && sqlite3 "$$DB" ".tables" 2>/dev/null | grep -q "bw_services"; then
              sqlite3 "$$DB" "BEGIN;
                UPDATE bw_services SET id='$${DOMAIN}', last_update=datetime('now') WHERE id='www.example.com';
                UPDATE bw_services_settings SET service_id='$${DOMAIN}' WHERE service_id='www.example.com';
                INSERT OR IGNORE INTO bw_services(id,method,is_draft,creation_date,last_update)
                  VALUES ('$${DOMAIN}','scheduler',0,datetime('now'),datetime('now'));
                INSERT OR REPLACE INTO bw_global_values(setting_id,value,suffix,method)
                  VALUES ('SERVER_NAME','$${DOMAIN}',0,'manual');
                INSERT OR REPLACE INTO bw_global_values(setting_id,value,suffix,method)
                  VALUES ('API_WHITELIST_IP','127.0.0.0/8 172.16.0.0/12',0,'manual');
                INSERT OR REPLACE INTO bw_services_settings(service_id,setting_id,value,suffix,method)
                  VALUES ('$${DOMAIN}','USE_UI','yes',0,'manual');
                INSERT OR REPLACE INTO bw_services_settings(service_id,setting_id,value,suffix,method)
                  VALUES ('$${DOMAIN}','USE_REVERSE_PROXY','yes',0,'manual');
                INSERT OR REPLACE INTO bw_services_settings(service_id,setting_id,value,suffix,method)
                  VALUES ('$${DOMAIN}','REVERSE_PROXY_HOST','http://nginx:80',0,'manual');
                INSERT OR REPLACE INTO bw_services_settings(service_id,setting_id,value,suffix,method)
                  VALUES ('$${DOMAIN}','REVERSE_PROXY_URL','/',0,'manual');
                INSERT OR REPLACE INTO bw_services_settings(service_id,setting_id,value,suffix,method)
                  VALUES ('$${DOMAIN}','AUTO_LETS_ENCRYPT','no',0,'manual');
                INSERT OR REPLACE INTO bw_services_settings(service_id,setting_id,value,suffix,method)
                  VALUES ('$${DOMAIN}','USE_WHITELIST','no',0,'manual');
              COMMIT;" && break
            fi
            sleep 2
          done
        ) &
        exec ./entrypoint.sh

  bunkerweb-scheduler:
    image: bunkerity/bunkerweb-scheduler:latest
    environment:
      DATABASE_URI: sqlite:////var/lib/bunkerweb/db.sqlite3
      BUNKERWEB_INSTANCES: http://bunkerweb:5000
    volumes:
      - bunkerweb_data:/var/lib/bunkerweb

  postgres:
    image: postgres:15-alpine
    user: "1000:1000"
    environment:
      - POSTGRES_USER=FluffFox
      - POSTGRES_DB=FluffFox_development
      - POSTGRES_HOST_AUTH_METHOD=trust
    volumes:
      - db_data:/var/lib/postgresql/data
    ports:
      - "${EXPOSED_POSTGRES_PORT:-34517}:5432"
  
  redis:
    image: redis:7.0.10-alpine
    command: redis-server --save 10 1 --loglevel warning
    volumes:
      - redis_data_v2:/data

  memcached:
    image: memcached:1.5.22-alpine
    user: "1000:1000"

  traefik:
    image: traefik:v2.10
    command:
      - --api.insecure=true
      - --providers.docker=true
      - --providers.docker.exposedbydefault=false
      - --entrypoints.web.address=:80
      - --entrypoints.websecure.address=:443
      - --entrypoints.websecure9001.address=:9001
      - --certificatesresolvers.le.acme.httpchallenge=true
      - --certificatesresolvers.le.acme.httpchallenge.entrypoint=web
      - --certificatesresolvers.le.acme.email=${LETSENCRYPT_EMAIL:-admin@example.com}
      - --certificatesresolvers.le.acme.storage=/letsencrypt/acme.json
    ports:
      - "80:80"
      - "443:443"
      - "9001:9001"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ./docker/traefik:/letsencrypt
    labels:
      - "traefik.http.routers.api.rule=Host(`traefik.${DANBOORU_DOMAIN:-localhost}`)"
      - "traefik.http.routers.api.service=api@internal"
    depends_on:
      - FluffFox

  opensearch:
    image: opensearchproject/opensearch:2.9.0
    environment:
      - discovery.type=single-node
      - logger.level=WARN
      - DISABLE_SECURITY_PLUGIN=true
      - DISABLE_INSTALL_DEMO_CONFIG=true
      - OPENSEARCH_JAVA_OPTS=-Xms1g -Xmx1g
    volumes:
      - opensearch_data:/usr/share/opensearch/data
    healthcheck:
      interval: 5s
      timeout: 2s
      retries: 12
      test: curl "opensearch:9200/_cluster/health?wait_for_status=yellow&timeout=2s"

  iqdb:
    image: ghcr.io/e621ng/iqdb:b988f000f17008677c7546c0c13623bc956b585d
    command: iqdb http 0.0.0.0 5588 /iqdb/e621_v2.db
    volumes:
      - iqdb_data:/iqdb

  # Useful for development

  tests:
    image: flufffox
    environment:
      <<: *common-env
      RAILS_ENV: test
    volumes:
      - .:/app
      - ./docker/danbooru_local_config.rb:/app/config/danbooru_local_config.rb
      - node_modules:/app/node_modules
    depends_on:
      <<: *common-depends-on
    entrypoint: bundle exec rails test
    profiles:
      - tests

  bundle:
    image: flufffox
    environment:
      <<: *common-env
      RAILS_ENV: development
    volumes:
      - .:/app
      - ./docker/danbooru_local_config.rb:/app/config/danbooru_local_config.rb
      - node_modules:/app/node_modules
    depends_on:
      <<: *common-depends-on
    entrypoint: bundle
    profiles:
      - bundle

  rails:
    image: flufffox
    environment:
      <<: *common-env
      RAILS_ENV: test
    volumes:
      - .:/app
      - ./docker/danbooru_local_config.rb:/app/config/danbooru_local_config.rb
      - node_modules:/app/node_modules
    depends_on:
      <<: *common-depends-on
    entrypoint: bundle exec rails
    profiles:
      - rails

  rails_dev:
    image: flufffox
    environment:
      <<: *common-env
      RAILS_ENV: development
    volumes:
      - .:/app
      - ./docker/danbooru_local_config.rb:/app/config/danbooru_local_config.rb
      - node_modules:/app/node_modules
    depends_on:
      <<: *common-depends-on
    entrypoint: bundle exec rails
    profiles:
      - rails_dev

  rubocop:
    image: flufffox
    volumes:
      - .:/app
      - rubocop_cache:/rubocop_cache
    entrypoint: bundle exec rubocop --cache-root /rubocop_cache
    profiles: 
      - rubocop

  linter:
    image: flufffox
    volumes:
      - .:/app
      - node_modules:/app/node_modules
    entrypoint: yarn run lint
    profiles: 
      - linter

volumes:
  post_data:
  iqdb_data:
  opensearch_data:
  db_data:
  redis_data_v2:
  bunkerweb_data:
  node_modules:
  rubocop_cache:
